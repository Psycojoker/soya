-extends "base.haml"
-load section_tags

-block head
  %link{href: "{{ STATIC_URL }}css/bootstrap-switch.min.css", rel: "stylesheet"}
  :css
    .bootstrap-switch {
      border-color: #3A3D44;
    }

    .bootstrap-switch .bootstrap-switch-label {
      background: #D0D0D0;
    }

-block content
  .row
    .col-md-6
      %h2 Utilisateur:
        =object.username
        %small.pull-right
          %a.btn.btn-primary{href: "{% url 'administration_user_update' object.pk %}"}
            Modifier

      %hr

      .well
        .row
          .col-md-6
            %p
              %b Nom:
              =object.last_name
            %p
              %b Prénom:
              =object.first_name
          .col-md-6
            %p
              %b Nom d'utilisateur:
              =object.username
            %p
              %b Adresse email:
              =object.email
        %p
          -if object.is_staff
            L'utilisateur est un membre de l'équipe
          -else
            L'utilisateur n'est pas un membre de l'équipe

    .col-md-6
      %h2 Permissions
      %hr

      -if object.is_staff
        %p L'utilisateur est un membre de l'équipe, il a accès à toutes les vidéos.
      -else
        %h3 Tournages
        %ul
          -for subsection in subsection_list
            -if subsection.section == "1"
              %li= subsection.title
              %ul
                -for subsubsection in subsection.subsubsection_set.all
                  %li= subsubsection.title
                    %input{type: "checkbox", name: "foobar", data-size: "mini", data-on-color: "success", data-off-color: "danger", data-on-text: "autorisé", data-off-text: "non&#8239;autorisé", data-user-id: "{{ object.id }}", data-section-id: "{{ subsubsection.id }}", data-has-permission: "{% is_user_have_access subsubsection object %}"}

-block javascript
  %script{src: "{{ STATIC_URL }}js/ajax_django_magic.js"}
  %script{src: "{{ STATIC_URL }}js/bootstrap-switch.min.js"}
  :javascript
    $(function() {
      $("[name='foobar']").each(function(index, data) {
        if (data.attributes["data-has-permission"].value == "true") {
          data.checked = true;
        }
        $(data).bootstrapSwitch();
        $(data).on("switchChange.bootstrapSwitch", function(event, value) {
          attributes = event.currentTarget.attributes;
          console.log(value);

          $.post("{% url 'administration_change_subsection_permission' %}", {
            "user": attributes["data-user-id"].value,
            "subsubsection": attributes["data-section-id"].value,
            "state": value
          })
        })
      });
    })
